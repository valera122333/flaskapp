<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Bot Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
        }
        .status-running { background: #28a745; color: white; }
        .status-stopped { background: #dc3545; color: white; }
        .status-starting { background: #ffc107; color: black; }
        .bot-card {
            transition: transform 0.3s;
        }
        .bot-card:hover {
            transform: translateY(-5px);
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <h1 class="card-title">
                    <i class="bi bi-robot"></i> Twitch Bot Manager
                </h1>
                <p class="card-text">Управление автоматическими ботами для Twitch</p>
                
                <div class="d-flex justify-content-center gap-3 mb-3">
                    <button id="startBtn" class="btn btn-success btn-lg">
                        <i class="bi bi-play-circle"></i> Запустить ботов
                    </button>
                    <button id="stopBtn" class="btn btn-danger btn-lg" disabled>
                        <i class="bi bi-stop-circle"></i> Остановить ботов
                    </button>
                    <button id="refreshBtn" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-clockwise"></i> Обновить
                    </button>
                </div>
                
                <div id="globalStatus" class="mt-3">
                    <span class="status-badge status-stopped">Боты остановлены</span>
                    <span class="ms-3" id="statusText">Готов к работе</span>
                </div>
            </div>
        </div>

        <!-- Bot Cards -->
        <div class="row" id="botsContainer">
            <!-- Боты будут загружены через JavaScript -->
        </div>

        <!-- Configuration Editor -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> Конфигурация ботов
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Редактировать конфигурацию JSON:</label>
                    <textarea id="configEditor" class="form-control" rows="15" style="font-family: monospace;"></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button id="saveConfigBtn" class="btn btn-primary">
                        <i class="bi bi-save"></i> Сохранить конфигурацию
                    </button>
                    <button id="loadConfigBtn" class="btn btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Загрузить текущую
                    </button>
                    <button id="resetConfigBtn" class="btn btn-warning">
                        <i class="bi bi-arrow-repeat"></i> Сбросить к дефолту
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> Логи активности</h5>
                <button id="clearLogsBtn" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i> Очистить логи
                </button>
            </div>
            <div class="card-body">
                <div class="log-container bg-dark text-light p-3 rounded" id="logContent">
                    Загрузка логов...
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery для упрощения AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        $(document).ready(function() {
            let updateInterval;
            
            // Загружаем начальные данные
            loadStatus();
            loadConfig();
            loadLogs();
            
            // Автоматическое обновление статуса каждые 5 секунд
            startAutoUpdate();
            
            // Кнопка запуска
            $('#startBtn').click(function() {
                $.post('/api/start', function(response) {
                    showAlert(response.message, response.success ? 'success' : 'danger');
                    loadStatus();
                }).fail(function() {
                    showAlert('Ошибка подключения к серверу', 'danger');
                });
            });
            
            // Кнопка остановки
            $('#stopBtn').click(function() {
                $.post('/api/stop', function(response) {
                    showAlert(response.message, response.success ? 'success' : 'danger');
                    loadStatus();
                }).fail(function() {
                    showAlert('Ошибка подключения к серверу', 'danger');
                });
            });
            
            // Кнопка обновления
            $('#refreshBtn').click(function() {
                loadStatus();
                loadLogs();
                showAlert('Данные обновлены', 'info');
            });
            
            // Сохранение конфигурации
            $('#saveConfigBtn').click(function() {
                const config = $('#configEditor').val();
                try {
                    JSON.parse(config); // Проверяем валидность JSON
                    $.ajax({
                        url: '/api/config',
                        type: 'POST',
                        contentType: 'application/json',
                        data: config,
                        success: function(response) {
                            showAlert(response.message, response.success ? 'success' : 'danger');
                            if (response.success) {
                                loadStatus();
                            }
                        }
                    });
                } catch (e) {
                    showAlert('Неверный формат JSON: ' + e.message, 'danger');
                }
            });
            
            // Загрузка текущей конфигурации
            $('#loadConfigBtn').click(function() {
                loadConfig();
                showAlert('Конфигурация загружена', 'info');
            });
            
            // Сброс конфигурации
            $('#resetConfigBtn').click(function() {
                if (confirm('Вы уверены? Это сбросит все настройки к значениям по умолчанию.')) {
                    $.ajax({
                        url: '/api/config',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "bots": [
                                {
                                    "nick": "zona_petuhov228",
                                    "channel": "eklerchickid",
                                    "oauth": "oauth:ваш_токен_здесь",
                                    "enabled": true,
                                    "questions_interval_min": 60,
                                    "questions_interval_max": 120
                                }
                            ],
                            "settings": {
                                "global_cooldown": 10,
                                "emote_chance_special": 0.8,
                                "emote_chance_normal": 0.3,
                                "max_emote_repeat": 3,
                                "openrouter_api_key": "ваш_ключ_здесь",
                                "model_name": "meta-llama/llama-3.1-8b-instruct"
                            },
                            "questions": [
                                "Пример вопроса 1",
                                "Пример вопроса 2"
                            ]
                        }),
                        success: function(response) {
                            showAlert(response.message, response.success ? 'success' : 'danger');
                            if (response.success) {
                                loadConfig();
                                loadStatus();
                            }
                        }
                    });
                }
            });
            
            // Очистка логов
            $('#clearLogsBtn').click(function() {
                if (confirm('Очистить все логи?')) {
                    // Здесь можно добавить API для очистки логов
                    $('#logContent').html('<em>Логи очищены</em>');
                }
            });
            
            // Функция загрузки статуса
            function loadStatus() {
                $.get('/api/status', function(data) {
                    updateUI(data);
                });
            }
            
            // Функция загрузки конфигурации
            function loadConfig() {
                $.get('/api/config', function(config) {
                    $('#configEditor').val(JSON.stringify(config, null, 2));
                });
            }
            
            // Функция загрузки логов
            function loadLogs() {
                $.get('/api/logs', function(data) {
                    if (data.success) {
                        $('#logContent').html(data.logs.join('').replace(/\n/g, '<br>'));
                        // Автоскролл вниз
                        const logContainer = $('#logContent');
                        logContainer.scrollTop(logContainer[0].scrollHeight);
                    }
                });
            }
            
            // Функция обновления интерфейса
            function updateUI(data) {
                // Глобальный статус
                const isRunning = data.is_running;
                $('#startBtn').prop('disabled', isRunning);
                $('#stopBtn').prop('disabled', !isRunning);
                
                const statusBadge = $('#globalStatus .status-badge');
                statusBadge.removeClass('status-running status-stopped status-starting');
                
                if (isRunning) {
                    statusBadge.addClass('status-running').text('Боты запущены');
                    $('#statusText').text(`Работают ${Object.keys(data.bots).length} ботов`);
                } else {
                    statusBadge.addClass('status-stopped').text('Боты остановлены');
                    $('#statusText').text('Готов к работе');
                }
                
                // Обновляем карточки ботов
                let botsHtml = '';
                for (const [botName, botData] of Object.entries(data.bots)) {
                    const statusClass = `status-${botData.status}`;
                    const enabledClass = botData.enabled ? 'text-success' : 'text-danger';
                    const enabledIcon = botData.enabled ? 'bi-toggle-on' : 'bi-toggle-off';
                    
                    botsHtml += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card bot-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title">
                                        <i class="bi bi-person-circle"></i> ${botName}
                                    </h5>
                                    <span class="status-badge ${statusClass}">${botData.status}</span>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Статус:</span>
                                        <span class="${enabledClass}">
                                            <i class="bi ${enabledIcon}"></i>
                                            ${botData.enabled ? 'Включен' : 'Выключен'}
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Сообщений:</span>
                                        <span class="text-primary">${botData.messages_sent}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Вопросов:</span>
                                        <span class="text-info">${botData.questions_asked}</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> 
                                        Последняя активность: ${botData.last_activity || 'Нет данных'}
                                    </small>
                                </div>
                                
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary toggle-bot-btn" 
                                            data-bot="${botName}" 
                                            data-enabled="${botData.enabled}">
                                        <i class="bi ${botData.enabled ? 'bi-pause' : 'bi-play'}"></i>
                                        ${botData.enabled ? 'Выключить' : 'Включить'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }
                
                $('#botsContainer').html(botsHtml || '<div class="col-12"><div class="alert alert-info">Боты не настроены</div></div>');
                
                // Добавляем обработчики для кнопок переключения ботов
                $('.toggle-bot-btn').click(function() {
                    const botName = $(this).data('bot');
                    $.post(`/api/bot/${botName}/toggle`, function(response) {
                        showAlert(response.message, response.success ? 'success' : 'danger');
                        if (response.success) {
                            loadStatus();
                        }
                    });
                });
            }
            
            // Функция показа уведомлений
            function showAlert(message, type = 'info') {
                const alertClass = `alert-${type}`;
                const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 1050; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                `;
                
                $('body').append(alertHtml);
                
                // Автоматическое скрытие через 5 секунд
                setTimeout(() => {
                    $('.alert').alert('close');
                }, 5000);
            }
            
            // Автоматическое обновление
            function startAutoUpdate() {
                if (updateInterval) clearInterval(updateInterval);
                updateInterval = setInterval(() => {
                    loadStatus();
                    loadLogs();
                }, 5000);
            }
            
            // Очистка интервала при закрытии страницы
            $(window).on('beforeunload', function() {
                if (updateInterval) clearInterval(updateInterval);
            });
        });
    </script>
</body>
</html>